name: Deploy to AWS EC2

on:
  pull_request_target:           # pull_request_target ì´ë²¤íŠ¸ëŠ” 'base' repoì—ë§Œ secretsë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    if: github.event.pull_request.merged == true  # PRì´ ë¨¸ì§€ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ GitHub ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ
      - name: Build and Push Docker Image
        run: |
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # linux/amd64 í”Œë«í¼ìœ¼ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ & latest íƒœê·¸ í‘¸ì‹œ
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          docker build --platform linux/amd64 \
            --build-arg DEBUG=${{ secrets.DEBUG }} \
            --build-arg SECRET_KEY=${{ secrets.SECRET_KEY }} \
            --build-arg DJANGO_DEPLOY=${{ secrets.DJANGO_DEPLOY }} \
            --build-arg DB_ENGINE=${{ secrets.DB_ENGINE }} \
            --build-arg DB_NAME=${{ secrets.DB_NAME }} \
            --build-arg DB_USER=${{ secrets.DB_USER }} \
            --build-arg DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            --build-arg DB_HOST=${{ secrets.DB_HOST }} \
            --build-arg DB_PORT=${{ secrets.DB_PORT }} \
            --build-arg SMS_TOKEN_KEY=${{ secrets.SMS_TOKEN_KEY }} \
            --build-arg SMS_API_KEY=${{ secrets.SMS_API_KEY }} \
            --build-arg SEND_PHONE=${{ secrets.SEND_PHONE }} \
            --build-arg SSODAA_BASE_URL=${{ secrets.SSODAA_BASE_URL }} \
            --build-arg REDIS_HOST=${{ secrets.REDIS_HOST }} \
            -t ${{ secrets.DOCKER_USERNAME }}/linenow:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/linenow:latest

      # 4ï¸âƒ£ EC2 ì„œë²„ì— SSH ì ‘ì† í›„ Blueâ€‘Green ë¬´ì¤‘ë‹¨ ë°°í¬
      - name: Deploy Blue-Green to AWS EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 1) í˜„ì¬ Active í¬íŠ¸ í™•ì¸ (upstream.confì—ì„œ)
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            ACTIVE_PORT=$(sudo grep -Po '127\.0\.0\.1:\K\d+' /etc/nginx/sites-available/default)
            if [ "$ACTIVE_PORT" = "8000" ]; then
              INACTIVE_PORT=8001
              INACTIVE_NAME=linenow_green
              ACTIVE_NAME=linenow_blue
            else
              INACTIVE_PORT=8000
              INACTIVE_NAME=linenow_blue
              ACTIVE_NAME=linenow_green
            fi
            echo "â–¶ Active: $ACTIVE_PORT($ACTIVE_NAME), Deploying new: $INACTIVE_PORT($INACTIVE_NAME)"

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
            echo "ê¸°ì¡´ media íŒŒì¼ ì™¸ë¶€ë¡œ ë³µì‚¬"

            # ì»¨í…Œì´ë„ˆ ë‚´ì— /media ë””ë ‰í† ë¦¬ê°€ ìˆëŠ”ì§€ ê²€ì‚¬
            if docker exec "$ACTIVE_NAME" test -d /media; then
              echo "media í´ë”ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ë³µì‚¬ ì¤‘..."
              docker cp "$ACTIVE_NAME":/media /home/ubuntu
            else
              echo "ì»¨í…Œì´ë„ˆ ë‚´ì— media í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            fi

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 2) ì´ì „ì— ëŒ€ê¸° ì¤‘ì´ë˜ ì»¨í…Œì´ë„ˆ ì œê±°
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ”„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ..."
            docker rm -f "$INACTIVE_NAME" || true

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 3) ìµœì‹  ì´ë¯¸ì§€ Pull & ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â¬‡ï¸ Pull latest image"
            docker pull ${{ secrets.DOCKER_USERNAME }}/linenow:latest

            echo "ğŸš€ Run new container ($INACTIVE_NAME) on port $INACTIVE_PORT"
            docker run -d \
              --name $INACTIVE_NAME \
              --network linenow-network \
              -p ${INACTIVE_PORT}:${INACTIVE_PORT} \
              -e REDIS_HOST=redis-server \
              -e PORT=${INACTIVE_PORT} \
              ${{ secrets.DOCKER_USERNAME }}/linenow:latest

            # media íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬
            echo "ubuntu/media í´ë”ë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬ ì¤‘..."
            if [ -d /home/ubuntu/media ]; then
              echo "media í´ë”ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬ ì¤‘..."
              docker cp /home/ubuntu/media "$ACTIVE_NAME":/
            else
              echo "ì™¸ë¶€ì— media í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            fi

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 4) DB ë§ˆì´ê·¸ë ˆì´ì…˜
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ›  Run migrations"
            docker exec $INACTIVE_NAME python manage.py migrate


            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 5) Nginx upstream í¬íŠ¸ êµì²´ & reload
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ”„ Switching Nginx to port $INACTIVE_PORT"
            sudo sed -i "s/127.0.0.1:${ACTIVE_PORT}/127.0.0.1:${INACTIVE_PORT}/" /etc/nginx/sites-available/default
            sudo nginx -t
            sudo systemctl reload nginx

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # 6) ê¸°ì¡´ Active ì»¨í…Œì´ë„ˆ ì‚­ì œ
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ—‘ï¸ Removing old container $ACTIVE_NAME"
            docker rm -f "$ACTIVE_NAME" || true

            echo "ğŸ§¹ ë¶ˆí•„ìš”í•œ Docker ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -a -f

            echo "âœ… Blueâ€‘Green ë°°í¬ ì™„ë£Œ! New live: $INACTIVE_NAME on $INACTIVE_PORT"