name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # ğŸš€ main ë¸Œëœì¹˜ì— pushë˜ë©´ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ GitHub ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 3ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ (ë¹Œë“œ ì‹œ GitHub Secrets ì‚¬ìš©)
      - name: Build and Push Docker Image
        run: |
          docker build --platform linux/amd64 \
            --build-arg DEBUG=${{ secrets.DEBUG }} \
            --build-arg SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            --build-arg DJANGO_DEPLOY="${{ secrets.DJANGO_DEPLOY }}" \
            --build-arg DB_ENGINE="${{ secrets.DB_ENGINE }}" \
            --build-arg DB_NAME="${{ secrets.DB_NAME }}" \
            --build-arg DB_USER="${{ secrets.DB_USER }}" \
            --build-arg DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --build-arg DB_HOST="${{ secrets.DB_HOST }}" \
            --build-arg DB_PORT="${{ secrets.DB_PORT }}" \
            -t ${{ secrets.DOCKER_USERNAME }}/linenow:latest .
          
          docker push ${{ secrets.DOCKER_USERNAME }}/linenow:latest

      # 4ï¸âƒ£ EC2 ì„œë²„ì— SSH ì ‘ì† í›„ ìµœì‹  ì»¨í…Œì´ë„ˆ ë°°í¬
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ”„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ..."
            docker stop linenow_backend || true
            docker rm linenow_backend || true
            
            echo "ğŸ§¹ ë¶ˆí•„ìš”í•œ Docker ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -a -f

            echo "â¬‡ï¸ ìµœì‹  Docker ì´ë¯¸ì§€ Pull..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/linenow:latest

            echo "ğŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
            docker run -d --name linenow_backend -p 8000:8000 ${{ secrets.DOCKER_USERNAME }}/linenow:latest

            echo "ğŸ›  ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰..."
            docker exec dongbak_backend python manage.py migrate

            echo "âœ… ë°°í¬ ì™„ë£Œ!"