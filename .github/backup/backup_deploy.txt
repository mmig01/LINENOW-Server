name: Deploy to AWS EC2

on:
  pull_request_target:           # pull_request_target ì´ë²¤íŠ¸ëŠ” 'base' repoì—ë§Œ secretsë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ GitHub ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ (ë¹Œë“œ ì‹œ GitHub Secrets ì‚¬ìš©)
      - name: Build and Push Docker Image
        run: |
          docker build --platform linux/amd64 \
            --build-arg DEBUG=${{ secrets.DEBUG }} \
            --build-arg SECRET_KEY=${{ secrets.SECRET_KEY }} \
            --build-arg DJANGO_DEPLOY=${{ secrets.DJANGO_DEPLOY }} \
            --build-arg DB_ENGINE=${{ secrets.DB_ENGINE }} \
            --build-arg DB_NAME=${{ secrets.DB_NAME }} \
            --build-arg DB_USER=${{ secrets.DB_USER }} \
            --build-arg DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            --build-arg DB_HOST=${{ secrets.DB_HOST }} \
            --build-arg DB_PORT=${{ secrets.DB_PORT }} \
            --build-arg SMS_TOKEN_KEY=${{ secrets.SMS_TOKEN_KEY }} \
            --build-arg SMS_API_KEY=${{ secrets.SMS_API_KEY }} \
            --build-arg SEND_PHONE=${{ secrets.SEND_PHONE }} \
            --build-arg SSODAA_BASE_URL=${{ secrets.SSODAA_BASE_URL }} \
            --build-arg REDIS_HOST=${{ secrets.REDIS_HOST }} \
            -t ${{ secrets.DOCKER_USERNAME }}/linenow:latest .
          
          docker push ${{ secrets.DOCKER_USERNAME }}/linenow:latest

      # 4ï¸âƒ£ EC2 ì„œë²„ì— SSH ì ‘ì† í›„ ìµœì‹  ì»¨í…Œì´ë„ˆ ë°°í¬
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ê¸°ì¡´ media íŒŒì¼ ì‚­ì œ"
            if [ -d "/home/ubuntu/media" ]; then
              rm -rf /home/ubuntu/media
            else
              echo "ğŸš¨ /home/ubuntu/media í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. Skipping deletion."
            fi

            echo "ê¸°ì¡´ media íŒŒì¼ ë³µì‚¬"
            # media í´ë”ë¥¼ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ë¡œ ë³µì‚¬
            docker cp linenow_backend:/media /home/ubuntu
            
            echo "ğŸ”„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ..."
            docker stop linenow_backend || true
            docker rm linenow_backend || true
            
            echo "ğŸ§¹ ë¶ˆí•„ìš”í•œ Docker ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -a -f

            echo "â¬‡ï¸ ìµœì‹  Docker ì´ë¯¸ì§€ Pull..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/linenow:latest

            echo "ğŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."

            docker run -d \
            --name linenow_backend \
            --network linenow-network \
            -p 8000:8000 \
            -e REDIS_HOST=redis-server \
            ${{ secrets.DOCKER_USERNAME }}/linenow:latest

            # media í´ë”ë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬
            if [ -d "/home/ubuntu/media" ]; then
              echo "ğŸ”„ media í´ë” ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬..."
              docker cp /home/ubuntu/media linenow_backend:/
            else
              echo "ğŸš¨ /home/ubuntu/media í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. Skipping copy."
            fi

            echo "ğŸ›  ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰..."
            docker exec linenow_backend python manage.py migrate

            echo "âœ… ë°°í¬ ì™„ë£Œ!"